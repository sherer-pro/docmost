# Технический аудит репозитория `docmost` (2026-03-01)

## Область проверки

Проверка выполнена по направлениям:
1. Безопасность и потенциальные уязвимости.
2. Архитектура и качество решений.
3. Согласованность модулей/компонентов/API.
4. Производительность и оптимизация.
5. Качество и актуальность документации.
6. Избыточность и дублирование логики.
7. Согласованность `.env.*`.

## Что было проверено автоматически

- Установка зависимостей: `pnpm install --frozen-lockfile`
- Сборка монорепозитория: `pnpm build`
- Линтеры: `pnpm lint`
- Тесты: `pnpm test`
- Аудит уязвимостей прод-зависимостей: `pnpm audit --prod`
- Проверка комментариев на английский: `pnpm check:comments:en` (обнаружены несоответствия)

## Ключевые наблюдения

### 1) Безопасность

1. **Есть критические и high-уязвимости в зависимостях** (в т.ч. `fast-xml-parser`, `minimatch`, `ajv`).
2. **CSP частично ослаблен для не-API роутов**: `script-src 'unsafe-inline'`, а также `frame-src: *` и `child-src: *`.
3. **Глобальный CORS включен без явной конфигурации** (`app.enableCors()`), что повышает риск ошибок конфигурации при изменениях/рефакторинге.
4. CSRF-механизм реализован, но зависит от корректной клиентской передачи cookie+header, что требует дополнительного интеграционного мониторинга.

### 2) Архитектура

1. Архитектура в целом модульная и читаемая (Nest modules + выделенные integration/core/common слои).
2. Есть технический долг по границам конфигурации: часть поведения задается напрямую через `process.env`, часть через `EnvironmentService`.
3. Для enterprise-модулей используется `require` + runtime ветвление — это рабочее, но менее прозрачно для статического анализа и рефакторинга.

### 3) Согласованность API/компонентов

1. Клиент использует как централизованный axios-клиент (`/api`, CSRF header), так и локальные `fetch`-вызовы в отдельных местах; это увеличивает риск разъезда поведения.
2. Контракт ответов API оборачивается на сервере в interceptor, а на клиенте есть точечные исключения на уровне path (`/api/pages/export`, `/api/spaces/export`) — это потенциальная зона хрупкости.

### 4) Производительность

1. Фронтенд-сборка показывает очень крупные чанки (`index` и `subset-shared.chunk`), есть предупреждения Vite о code splitting.
2. Есть предупреждение о конфликте статического и динамического импорта `@excalidraw/excalidraw`, что препятствует оптимальному чанкингу.

### 5) Документация

1. Базовая документация по запуску/чеклистам есть и полезна.
2. Требуется усиление «операционной» части: фиксировать допущения безопасности (CSP/CORS/CSRF), официальную политику по обновлению зависимостей и SLA по security-fix.
3. Нужен единый и поддерживаемый реестр переменных окружения (server + client), чтобы исключить дрейф между кодом и `.env.example`.

### 6) Избыточность и дублирование

1. Есть дублирование паттернов настройки/обработки (например, спец-исключения по endpoint path на клиенте).
2. Повторяется логика запуска/интерсепторов в `main.ts` и `collab-main.ts`; стоит формализовать общий bootstrap-фабричный слой.

### 7) `.env.*` согласованность

1. В репозитории обнаружен только `.env.example`.
2. Валидация окружения сервера покрывает широкий набор переменных (включая `SEARCH_DRIVER`, `AI_*`, `TYPESENSE_*`, `COLLAB_URL` и др.), но эти переменные не полностью отражены в `.env.example`.
3. На фронтенде `vite.config.ts` читает переменные через `loadEnv(..., envPath, "")` из корня монорепо; нужна унифицированная документация по источнику и приоритетам env для client/server.

---

## Бэклог задач по итогам аудита

Ниже — минимально необходимый набор задач (приоритет `P0`-`P3`, где `P0` — срочно).

### Безопасность

- **AUD-SEC-001 (P0):** Обновить/зафиксировать `fast-xml-parser` до безопасной версии (`>=5.3.8`) через `pnpm.overrides` или обновление транзитивных зависимостей AWS SDK.
- **AUD-SEC-002 (P1):** Обновить `minimatch` до версии без ReDoS (`>=9.0.7`) и проверить цепочки через `glob`/`@fastify/static`.
- **AUD-SEC-003 (P1):** Обновить `ajv` до `>=8.18.0` либо зафиксировать безопасную транзитивную версию.
- **AUD-SEC-004 (P1):** Ввести security-gate в CI/локальный pipeline: блокирующая проверка `pnpm audit --prod` с allowlist по срокам.
- **AUD-SEC-005 (P1):** Ужесточить CSP для HTML-роутов: минимизировать/исключить `unsafe-inline`, ограничить `frame-src` и `child-src` до явного allowlist.
- **AUD-SEC-006 (P2):** Явно описать и зафиксировать политику CORS (origin allowlist, credentials, headers, methods) вместо неявного `enableCors()`.

### Архитектура и согласованность

- **AUD-ARC-001 (P2):** Унифицировать доступ к env-конфигурации: запретить прямое чтение `process.env` вне bootstrap/конфиг-слоя.
- **AUD-ARC-002 (P2):** Выделить общий bootstrap helper для `main.ts` и `collab-main.ts` (security headers, interceptors, hooks).
- **AUD-API-001 (P2):** Централизовать все HTTP-вызовы фронтенда через единый transport слой (axios/fetch adapter) с едиными правилами CSRF/auth/error handling.
- **AUD-API-002 (P3):** Убрать hardcoded endpoint-исключения из response interceptor, заменить на мета-флаги/типизированные клиенты.

### Производительность

- **AUD-PERF-001 (P1):** Выполнить план code splitting для тяжелых client-чанков (`index`, `subset-shared.chunk`) с целевыми метриками TTI/LCP.
- **AUD-PERF-002 (P2):** Исправить паттерн импорта Excalidraw (либо только dynamic import, либо только static), чтобы восстановить ожидаемый split.
- **AUD-PERF-003 (P2):** Добавить регулярный bundle-анализ (например, `rollup-plugin-visualizer`) в release-checklist.

### Документация и процессы

- **AUD-DOC-001 (P1):** Добавить официальный security maintenance policy: как часто выполняется audit, кто владелец, SLA по critical/high.
- **AUD-DOC-002 (P1):** Создать единый каталог переменных окружения (server/client), с обязательностью, дефолтами, примерами и влиянием на безопасность.
- **AUD-DOC-003 (P2):** Привести в соответствие документацию локального окружения с реальными входами `vite` и `EnvironmentService`.

### Качество кода

- **AUD-QA-001 (P1):** Исправить неанглоязычные комментарии в коде, чтобы проходил `pnpm check:comments:en`.
- **AUD-QA-002 (P2):** Добавить интеграционные тесты на безопасность заголовков (CSP/HSTS/XFO) и CORS-политику.
- **AUD-QA-003 (P2):** Добавить контрактные тесты на CSRF-поведение для всех mutating endpoint (включая исключения).

---

## Рекомендуемый порядок выполнения

1. `AUD-SEC-001..004` (dependency security).
2. `AUD-SEC-005..006` + `AUD-QA-002..003` (runtime security hardening).
3. `AUD-PERF-001..003` (frontend perf).
4. `AUD-ARC-001..002` + `AUD-API-001..002` (архитектурная консолидация).
5. `AUD-DOC-*` + `AUD-QA-001` (устойчивость процессов и документации).
